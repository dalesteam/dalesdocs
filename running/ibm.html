
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Immersed Boundary Method (IBM) &#8212; The DALESdocs</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'running/ibm';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using the GPU" href="gpu.html" />
    <link rel="prev" title="Running a case with tracers" href="tracers.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/daleslogo.png" class="logo__image only-light" alt="The DALESdocs - Home"/>
    <script>document.write(`<img src="../_static/daleslogo.png" class="logo__image only-dark" alt="The DALESdocs - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    DALES documentation
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started with DALES!</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="changes.html">Changes between DALES 4.x and 5.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="settingup.html">Setting up your system</a></li>
<li class="toctree-l1"><a class="reference internal" href="compilation.html">Compilation of DALES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Running your first case in DALES</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="testcase.html">TEST CASE</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Setting up your own case</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basic_namoptions.html">Basic Namoptions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced DALES options</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tracers.html">Running a case with tracers</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Immersed Boundary Method (IBM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">Using the GPU</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Recent publications using DALES</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="papers.html">List of publications using DALES</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing to the documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developers/usermanual.html">User Manual</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dalesteam/dalesdocs" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dalesteam/dalesdocs/edit/main/book/running/ibm.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dalesteam/dalesdocs/issues/new?title=Issue%20on%20page%20%2Frunning/ibm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/running/ibm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Immersed Boundary Method (IBM)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#general-description-of-the-ibm">General description of the IBM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-ibm-file">Preparing the IBM file</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-wavefront-obj-format">Using Wavefront OBJ format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alternative-directly-from-lidar">Alternative: directly from LiDAR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-namibm-options">Setting &amp;NAMIBM options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-how-to-visualize-ibm-runs">TODO: How to visualize IBM runs</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="immersed-boundary-method-ibm">
<h1>Immersed Boundary Method (IBM)<a class="headerlink" href="#immersed-boundary-method-ibm" title="Link to this heading">#</a></h1>
<p>Starting from version 5.0, DALES has a grid-conforming Immersed Boundary Method (IBM) implemented. This implementation is a modified version of an older implementation (see <a class="reference external" href="https://resolver.tudelft.nl/uuid:5d93a697-be49-4f63-b871-b763bc327139">Tomas, 2016</a>). This section explains the IBM implementation, how to prepare a run with immersed boundaries, and how to start it.</p>
<section id="general-description-of-the-ibm">
<h2>General description of the IBM<a class="headerlink" href="#general-description-of-the-ibm" title="Link to this heading">#</a></h2>
<p>The Immersed Boundary Method implemented in DALES is <em>grid conforming</em>, meaning that a computational grid cell is either completely set as <em>free fluid</em> or <em>solid object</em>. This effectively changes complex shapes (e.g., inclined roofs) to a cubical representation, which may be innaccurate when the resolution is much coarser than the size of such shapes. The benefit is however its ease of implementation, incl. control over the fluxes and velocity values. Boundaries between fluid and solid always coincide with a cubic face at which the corresponding velocity component is set to zero, thereby ensuring no advection over such boundaries occurs. Momentum and scalar values adjacent to solid cells are corrected by locally adapting the tendencies in two steps:</p>
<ol class="arabic simple">
<li><p>regular contributions to the diffusive flux over faces (as if no solid were present) are substracted;</p></li>
<li><p>new contributions as a result of wall drag or wall flux are calculated and added.</p></li>
</ol>
<p>No correction for subgrid TKE is applied as diffusive flux contribution over walls is assumed to be negligble (which may require further testing). Tendencies for values inside solids are every substep set to correct for any drift, for example, for temperature <code class="docutils literal notranslate"><span class="pre">thlp(i,j,k)</span> <span class="pre">=</span> <span class="pre">(thlibm</span> <span class="pre">-</span> <span class="pre">thl0(i,j,k))*rk3coefi</span></code>.</p>
<p style="text-align: center;"><< still add sketch >></p>
<p>Currently, boundary conditions for solid walls are still limited. They are listed below:</p>
<ul class="simple">
<li><p><strong>temperature:</strong> Dirichlet condition (fixed temperature) for or zero heat flux across vertical walls and roofs. These values are set to separate constant values for walls <code class="docutils literal notranslate"><span class="pre">thlwall</span></code> and roofs <code class="docutils literal notranslate"><span class="pre">thlroof</span></code>, allowing some thermal response between fluid and solid.</p></li>
<li><p><strong>moisture:</strong> No flux across walls and roofs.</p></li>
<li><p><strong>scalars:</strong> No flux across walls and roofs.</p></li>
</ul>
</section>
<section id="preparing-the-ibm-file">
<h2>Preparing the IBM file<a class="headerlink" href="#preparing-the-ibm-file" title="Link to this heading">#</a></h2>
<p>Due to the grid conformity of the IBM, only obstacle heights are required to use the IBM. That implies overhanging structures are not allowed, meaning no fluid cell can be positioned vertically below a solid cell. Obstacle heights should be supplied as a list of values in a file named <code class="docutils literal notranslate"><span class="pre">ibm.inp.&lt;iexpnr&gt;</span></code>, preceded by seven header lines (see example below). These values are ordered in a row-major ordering, with the first value corresponding to the top-left corner of the domain <code class="docutils literal notranslate"><span class="pre">(xmin,ymax)</span></code>, the second value being one position to the right <code class="docutils literal notranslate"><span class="pre">(xmin+1*dx,ymax)</span></code>, and the last value corresponding to the bottom-right corner <code class="docutils literal notranslate"><span class="pre">(xmax,ymin)</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXPERIMENT: ibm example</span>
<span class="c1"># Horizontal grid points Nx =  256, Ny =  256</span>
<span class="c1"># Horizontal grid size Delta x =   5.00, Delta y =   5.00</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
   <span class="mf">0.0</span>
   <span class="mf">0.0</span>
   <span class="mf">5.7</span>
   <span class="mf">5.7</span>
   <span class="mf">6.8</span>
   <span class="mf">5.0</span>
   <span class="mf">0.0</span>
   <span class="o">.</span>
   <span class="o">.</span>
</pre></div>
</div>
<p>Although the structure of this input file is straightforward, creating it requires some steps. Data of the desired obstacles first need to be acquired and then processed to get the correct input file.</p>
<section id="using-wavefront-obj-format">
<h3>Using Wavefront OBJ format<a class="headerlink" href="#using-wavefront-obj-format" title="Link to this heading">#</a></h3>
<p>The following example assumes that your buildings are represented in the Wavefront OBJ format. Building representation in OBJ format can be obtained directly via <a class="reference external" href="https://3dbag.nl">https://3dbag.nl</a> for the Netherlands <strong>or</strong> be created via the open-source software <a class="reference external" href="https://github.com/tudelft3d/City4CFD">City4CFD</a>. Note that the second option is preferred when there is also topography involved and a high degree of accuracy is required. Further, the example assumes that the coordinates are specified in the Dutch RD coordinate system (<em>Rijksdriehoeksmeting</em>). Extension to different coordinates is trivial as long as an orthogonal coordinate system is used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">##### IMPORT PACKAGES #####</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">trimesh</span> <span class="c1"># &lt;-- this package is required to handle OBJ files!</span>

<span class="c1">##### SPECIFY GENERAL SETTINGS #####</span>

<span class="n">iexpnr</span> <span class="o">=</span> <span class="s1">&#39;001&#39;</span> 
<span class="n">building_file</span> <span class="o">=</span> <span class="s1">&#39;Buildings.obj&#39;</span>
<span class="n">terrain_file</span>  <span class="o">=</span> <span class="s1">&#39;Terrain.obj&#39;</span>

<span class="n">dx</span> <span class="o">=</span> <span class="mf">5.</span>     <span class="c1"># horizontal grid spacing in meters</span>
<span class="n">Nx</span> <span class="o">=</span> <span class="mi">256</span>    <span class="c1"># number of grid cells in x-direction</span>
<span class="n">Ny</span> <span class="o">=</span> <span class="mi">256</span>    <span class="c1"># number of grid cells in y-direction</span>
<span class="n">bz</span> <span class="o">=</span> <span class="mi">8</span>      <span class="c1"># number of blend-out cells around edge, where no buildings will be placed</span>

<span class="n">origin_obj</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">139751</span><span class="p">,</span> <span class="mi">455487</span><span class="p">]</span>  <span class="c1"># RD-COORDINATES of the center of domain (as in OBJ file)</span>
                                <span class="c1"># this example is situated on the Utrecht University campus</span>
                                <span class="c1"># alternatively, if these are lower-left of the OBJ file, </span>
                                <span class="c1"># origin_shift below should be set to zero</span>
<span class="n">float_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>

<span class="c1">##### PROCESSING DATA #####</span>

<span class="n">origin_shift</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">dx</span><span class="o">*</span><span class="n">Nx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">dx</span><span class="o">*</span><span class="n">Ny</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># shift from origin_obj to lower left corner of domain</span>
<span class="n">origin_les</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">origin_obj</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">origin_shift</span><span class="p">)</span>

<span class="c1"># Import OBJ files containing meshes and shift them</span>
<span class="n">mesh1</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">building_file</span><span class="p">)</span>

<span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">mesh2</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">terrain_file</span><span class="p">)</span>

<span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">origin_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Combine building and terrain meshes in one mesh</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">boolean</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="n">mesh1</span><span class="p">,</span> <span class="n">mesh2</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;blender&#39;</span><span class="p">,</span> <span class="n">check_volume</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Voxelize the OBJ-mesh to computational grid spacing dx</span>
<span class="n">voxgrid</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">voxelized</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">hollow</span><span class="p">()</span>

<span class="c1"># Create region of interest for LES</span>
<span class="n">end</span> <span class="o">=</span> <span class="p">[</span><span class="n">Nx</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">Ny</span><span class="o">*</span><span class="n">dy</span><span class="p">]</span>
<span class="n">xh_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span> 
<span class="n">yh_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dy</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span> 

<span class="c1"># Prepare arrays for obstacle heights. Mind the orientation:</span>
<span class="c1">#   Voxgrid structure orders data as increasing x, then y (xy-ordering); start bottom-left</span>
<span class="c1">#   IBM input file should however start at top-left (largest y, smallest x; row-major) </span>
<span class="c1">#   Column indices &#39;j&#39; correspond to the x-dimension and row indices &#39;i&#39; to y-dimension </span>
<span class="c1">#   DALES itself corrects for this again by reading the file upside-down</span>
<span class="c1">#   There is potential to correct for this code-wise (which has not been done yet)</span>

<span class="n">data_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">mask_2d</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="k">for</span> <span class="n">bb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">voxgrid</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">xpos</span> <span class="o">=</span> <span class="n">voxgrid</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ypos</span> <span class="o">=</span> <span class="n">voxgrid</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">zhei</span> <span class="o">=</span> <span class="n">voxgrid</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">bb</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">ii_pos</span> <span class="o">=</span> <span class="n">Ny</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ypos</span><span class="o">/</span><span class="n">dy</span><span class="p">))</span>
    <span class="n">jj_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xpos</span><span class="o">/</span><span class="n">dx</span><span class="p">))</span>

    <span class="k">if</span><span class="p">(</span><span class="n">bz</span><span class="o">&lt;=</span><span class="n">jj_pos</span><span class="o">&lt;</span><span class="n">Ny</span><span class="o">-</span><span class="n">bz</span> <span class="ow">and</span> <span class="n">bz</span><span class="o">&lt;=</span><span class="n">ii_pos</span><span class="o">&lt;</span><span class="n">Ny</span><span class="o">-</span><span class="n">bz</span><span class="p">):</span>
        <span class="n">data_les</span><span class="p">[</span><span class="n">ii_pos</span><span class="p">,</span><span class="n">jj_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">zhei</span> 
        <span class="n">mask_2d</span> <span class="p">[</span><span class="n">ii_pos</span><span class="p">,</span><span class="n">jj_pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">zhei</span> <span class="o">&gt;=</span> <span class="n">dx</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum height in area: </span><span class="si">{:&gt;3.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_les</span><span class="p">)))</span>

<span class="c1">##### WRITE IBM INPUT FILE #####</span>
<span class="n">do</span> <span class="o">=</span> <span class="n">data_les</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="c1"># first meshgridded and then converted to list in right direction</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ibm.inp.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iexpnr</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

<span class="c1"># Ensure 7 lines of text heade</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# EXPERIMENT: ibm example)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Horizontal grid points Nx = </span><span class="si">{:&gt;4d}</span><span class="s1">, Ny = </span><span class="si">{:&gt;4d}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Horizontal grid size Delta x = </span><span class="si">{:&gt;6.2f}</span><span class="s1">, Delta y = </span><span class="si">{:&gt;6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dx</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&gt;6.1f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">do</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 

<span class="c1">##### OPTIONAL: PLOT VOXELIZED BUILDINGS #####</span>
<span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xh_les</span><span class="p">,</span><span class="n">yh_les</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span> 
<span class="n">y_mesh</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">y_mesh</span><span class="p">)</span>

<span class="n">xp</span> <span class="o">=</span> <span class="n">x_mesh</span><span class="p">[</span><span class="n">mask_2d</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>   <span class="c1"># like flatten, make continuous vector of xdata</span>
<span class="n">yp</span> <span class="o">=</span> <span class="n">y_mesh</span><span class="p">[</span><span class="n">mask_2d</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>   
<span class="n">zp</span> <span class="o">=</span> <span class="n">data_les</span><span class="p">[</span><span class="n">mask_2d</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> 
<span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">zp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar3d</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">(</span><span class="n">origin_les</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">origin_les</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">*</span><span class="n">Nx</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">(</span><span class="n">origin_les</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">origin_les</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">*</span><span class="n">Ny</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=-</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="alternative-directly-from-lidar">
<h3>Alternative: directly from LiDAR<a class="headerlink" href="#alternative-directly-from-lidar" title="Link to this heading">#</a></h3>
<p>Sometimes OBJ files are not readily available and creating them yourself with City4CFD is not feasible. Luckily, many authorities nowadays have made accurate LiDAR scans (point clouds) publicly available. For example, tiled LiDAR scans for the Netherlands (AHN) can accessed via <a class="reference external" href="https://geotiles.citg.tudelft.nl/">GeoTiles</a> and tiled scans for France can be accessed via <a class="reference external" href="https://geoservices.ign.fr/lidarhd">IGN France</a>. Such LiDAR scans can be quickly voxelized for use with our IBM. Further, most LiDAR return points have a classification, which makes it possible to separate buildings from ground points. The table below shows the typical classification used by the Dutch AHN scans (which may vary among different institutes).</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Classification value</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>unclassified (mostly vegetation)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p>ground points</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">6</span></code></p></td>
<td><p>building points</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">9</span></code></p></td>
<td><p>water points</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">26</span></code></p></td>
<td><p>reserved for ASPRS definition</p></td>
</tr>
</tbody>
</table>
</div>
<p>The example below shows the basics of processing such LiDAR scans. Note that the size of the domain is inferred from the dimensions of the LiDAR tile (assumed to be in meters). If you want only part of the domain, you will have to subsample <code class="docutils literal notranslate"><span class="pre">data_les</span></code> yourself. Likewise, if you want to simulate a larger region, you have to merge LiDAR tiles yourself.</p>
<p><em>Thanks to Mahmoud Ahmed (TUDelft) for sharing his Python script.</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">##### IMPORT PACKAGES #####</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">open3d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">o3d</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">laspy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lp</span>      <span class="c1"># &lt;-- this package should be installed with laz backend</span>
                        <span class="c1"># pip3 install &quot;laspy[lazrs,laszip]&quot;</span>

<span class="c1">##### SPECIFY INPUT FILE AND VOXEL SIZE (=GRID SIZE) #####</span>

<span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;37EN2_11.LAZ&#39;</span>   <span class="c1"># AHN3 Wippolder area in Delft, downloaded from GeoTiles </span>
<span class="n">dx</span>   <span class="o">=</span> <span class="mf">10.</span>

<span class="c1">##### PROCESS LIDAR POINT CLOUDS #####</span>

<span class="n">point_cloud</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="c1"># Optional: only extract one or two classes. In Dutch AHN, buildings correspond to class 6</span>
<span class="n">point_cloud</span> <span class="o">=</span> <span class="n">point_cloud</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">pcd</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">PointCloud</span><span class="p">()</span>

<span class="n">pcd</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point_cloud</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">point_cloud</span><span class="o">.</span><span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

<span class="n">pcd</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">utility</span><span class="o">.</span><span class="n">Vector3dVector</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">point_cloud</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">point_cloud</span><span class="o">.</span><span class="n">blue</span><span class="p">))</span>
    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>

<span class="c1"># Create voxels from point cloud</span>
<span class="n">voxel_grid</span>  <span class="o">=</span> <span class="n">o3d</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">VoxelGrid</span><span class="o">.</span><span class="n">create_from_point_cloud</span><span class="p">(</span><span class="n">pcd</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span>
<span class="n">voxels</span>      <span class="o">=</span> <span class="n">voxel_grid</span><span class="o">.</span><span class="n">get_voxels</span><span class="p">()</span>

<span class="c1"># Determine number of voxels in x- and y-directions</span>
<span class="n">Lx</span> <span class="o">=</span> <span class="n">voxel_grid</span><span class="o">.</span><span class="n">get_oriented_bounding_box</span><span class="p">()</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Ly</span> <span class="o">=</span> <span class="n">voxel_grid</span><span class="o">.</span><span class="n">get_oriented_bounding_box</span><span class="p">()</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">Nx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Lx</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Lx</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Lx</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
<span class="n">Ny</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Ly</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Ly</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Ly</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

<span class="c1"># Prepare arrays for obstacle heights and coordinate meshes</span>
<span class="n">data_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">mask_2d</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="n">xh_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nx</span><span class="o">*</span><span class="n">dx</span><span class="o">-</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nx</span><span class="p">)</span> 
<span class="n">yh_les</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="o">*</span><span class="n">dx</span><span class="o">-</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">Ny</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">voxels</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">grid_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Nx</span> <span class="ow">or</span> <span class="n">v</span><span class="o">.</span><span class="n">grid_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">Ny</span><span class="p">):</span> <span class="k">continue</span>
    <span class="n">ii_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">grid_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">jj_pos</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">grid_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">zhei</span>   <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">grid_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="c1"># dx is also voxel size</span>

    <span class="n">data_les</span><span class="p">[</span><span class="n">ii_pos</span><span class="p">,</span><span class="n">jj_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_les</span><span class="p">[</span><span class="n">ii_pos</span><span class="p">,</span><span class="n">jj_pos</span><span class="p">],</span> <span class="n">zhei</span><span class="p">)</span>
    <span class="n">mask_2d</span> <span class="p">[</span><span class="n">ii_pos</span><span class="p">,</span><span class="n">jj_pos</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">##### OPTIONAL: PLOT VOXELIZED POINT CLOUD #####</span>

<span class="c1"># Visualize voxels</span>
<span class="n">o3d</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_geometries</span><span class="p">([</span><span class="n">voxel_grid</span><span class="p">])</span>

<span class="c1">##### OPTIONAL: EXPORT THE MESH AS .PLY #####</span>
<span class="c1"># vox_mesh = o3d.geometry.TriangleMesh()</span>

<span class="c1"># for v in voxels:</span>
<span class="c1">#     cube = o3d.geometry.TriangleMesh.create_box(width=1, height=1, depth=1)</span>
<span class="c1">#     cube.paint_uniform_color(v.color)</span>
<span class="c1">#     cube.translate(v.grid_index, relative=False)</span>
<span class="c1">#     vox_mesh += cube</span>

<span class="c1"># # Export the mesh as an .obj or .ply file</span>
<span class="c1"># vox_mesh.translate([0.5, 0.5, 0.5], relative=True)</span>
<span class="c1"># vox_mesh.scale(dx, [0, 0, 0])</span>
<span class="c1"># vox_mesh.translate(voxel_grid.origin, relative=True)</span>

<span class="c1"># o3d.io.write_triangle_mesh(file+&quot;voxel_mesh_h.ply&quot;, vox_mesh)</span>
</pre></div>
</div>
<p>From this point, writing of the IBM input file is the same as in the earlier example.</p>
</section>
</section>
<section id="setting-namibm-options">
<h2>Setting &amp;NAMIBM options<a class="headerlink" href="#setting-namibm-options" title="Link to this heading">#</a></h2>
<p>Now the input file containing the obstacle heights has been prepared, you are almost ready to use the IBM. The final step is to switch on the IBM and supply general settings in the <code class="docutils literal notranslate"><span class="pre">&amp;NAMIBM</span></code> section of the <code class="docutils literal notranslate"><span class="pre">namoptions.&lt;iexpnr&gt;</span></code> file. The available settings are show in table below.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Options</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Allowed Values</p></th>
<th class="head"><p>Description / Remark</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">lapply_ibm</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.false.</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.true.</span></code> or <code class="docutils literal notranslate"><span class="pre">.false.</span></code></p></td>
<td><p>switch to enable immersed boundary method</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">lwallheat</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.false.</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.true.</span></code> or <code class="docutils literal notranslate"><span class="pre">.false.</span></code></p></td>
<td><p>switch to apply lateral heat flux from buildings</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">lpoislast</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.true.</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.true.</span></code> or <code class="docutils literal notranslate"><span class="pre">.false.</span></code></p></td>
<td><p>switch to apply Poisson solver <strong>after</strong> the IBM</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">thlwall</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(293\,\mathrm{K}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span></p></td>
<td><p>potential temperature of vertical walls <br/>(only if <code class="docutils literal notranslate"><span class="pre">lwallheat=.true.</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">thlroof</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(293\,\mathrm{K}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span></p></td>
<td><p>potential temperature of roof faces</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">thlibm</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(293\,\mathrm{K}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span></p></td>
<td><p>potential temperature inside of obstacles</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">qtibm</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(0\,\mathrm{kg/kg}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span></p></td>
<td><p>moisture inside of obstacles</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">z0m_wall</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(0.03\,\mathrm{m}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span> and <span class="math notranslate nohighlight">\(&lt;\)</span> <code class="docutils literal notranslate"><span class="pre">zf(1)</span></code></p></td>
<td><p>roughness length for momentum at walls/roofs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">z0h_wall</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(0.03\,\mathrm{m}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(&gt;0\)</span> and <span class="math notranslate nohighlight">\(&lt;\)</span> <code class="docutils literal notranslate"><span class="pre">zf(1)</span></code></p></td>
<td><p>roughness length for heat at walls/roofs</p></td>
</tr>
</tbody>
</table>
</div>
<p>At runtime, DALES will check for potentially conflicting options from different modules and throw ERROR messages when required.</p>
</section>
<section id="todo-how-to-visualize-ibm-runs">
<h2>TODO: How to visualize IBM runs<a class="headerlink" href="#todo-how-to-visualize-ibm-runs" title="Link to this heading">#</a></h2>
<p>…</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./running"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tracers.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Running a case with tracers</p>
      </div>
    </a>
    <a class="right-next"
       href="gpu.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using the GPU</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#general-description-of-the-ibm">General description of the IBM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-ibm-file">Preparing the IBM file</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-wavefront-obj-format">Using Wavefront OBJ format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alternative-directly-from-lidar">Alternative: directly from LiDAR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-namibm-options">Setting &amp;NAMIBM options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-how-to-visualize-ibm-runs">TODO: How to visualize IBM runs</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The DALES team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>